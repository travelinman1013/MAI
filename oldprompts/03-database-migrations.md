# 03 - Database Migrations

## Task Information

| Field | Value |
|-------|-------|
| **Project** | MAI PostgreSQL + Qdrant Implementation |
| **Archon Project ID** | `42e538a6-9b44-4e9c-9a8a-2a8bcb6e2983` |
| **Archon Task ID** | `61f2e7af-7cbc-4541-a2f1-ba8d63051259` |
| **Sequence** | 3 of 5 |
| **Depends On** | 02-environment-config.md completed |

---

## Archon Task Management

**Mark task as in-progress when starting:**
```bash
curl -X PUT "http://localhost:8181/api/tasks/61f2e7af-7cbc-4541-a2f1-ba8d63051259" \
  -H "Content-Type: application/json" \
  -d '{"status": "in_progress"}'
```

**Mark task as done when complete:**
```bash
curl -X PUT "http://localhost:8181/api/tasks/61f2e7af-7cbc-4541-a2f1-ba8d63051259" \
  -H "Content-Type: application/json" \
  -d '{"status": "done"}'
```

---

## Context

Steps 01-02 set up Docker services and environment configuration. The PostgreSQL container is now running but has no tables.

The MAI Framework already has:
- SQLAlchemy models in `src/infrastructure/database/models.py`:
  - User
  - UserSession
  - Conversation
  - Message
  - Memory
- Alembic configured in `alembic.ini` and `src/infrastructure/database/migrations/env.py`
- **No migration versions exist yet** (migrations/versions/ is empty)

We need to generate the initial migration and apply it to create all tables.

---

## Requirements

### 1. Verify Alembic Configuration

Check that `alembic.ini` has the correct script location:

```ini
script_location = src/infrastructure/database/migrations
```

### 2. Update migrations/env.py for Docker

The existing `env.py` loads the database URL from settings. Ensure it works with the Docker environment:

```python
# In env.py, the settings should pick up DATABASE__URL from environment
settings = get_settings()
config.set_main_option("sqlalchemy.url", settings.database.url)
```

### 3. Generate Initial Migration

Run Alembic to auto-generate migration from models:

```bash
# From project root, inside the mai-api container or with local Python
cd /Users/maxwell/Projects/MAI

# Option A: Run locally (requires DATABASE__URL pointing to localhost:5432)
DATABASE__URL=postgresql+asyncpg://postgres:postgres@localhost:5432/mai_framework \
  poetry run alembic revision --autogenerate -m "Initial schema - users sessions conversations messages memories"

# Option B: Run inside Docker container
docker exec mai-api alembic revision --autogenerate -m "Initial schema - users sessions conversations messages memories"
```

### 4. Review Generated Migration

The generated migration file in `src/infrastructure/database/migrations/versions/` should include:

- `users` table with username, email, hashed_password, is_active, is_superuser, full_name
- `user_sessions` table with user_id FK, tokens, expiry
- `conversations` table with user_id FK, agent_name, title, is_archived
- `messages` table with conversation_id FK, role, content, tool fields
- `memories` table with user_id FK, agent_name, content, memory_type, importance, qdrant_id
- All indexes defined in models
- UUID primary keys with proper PostgreSQL UUID type

### 5. Apply Migration

```bash
# Option A: Run locally
DATABASE__URL=postgresql+asyncpg://postgres:postgres@localhost:5432/mai_framework \
  poetry run alembic upgrade head

# Option B: Run inside Docker container
docker exec mai-api alembic upgrade head
```

### 6. (Optional) Create pgvector Extension Migration

If you want pgvector available for future use, create a manual migration:

```bash
poetry run alembic revision -m "Enable pgvector extension"
```

Then edit the generated file:

```python
def upgrade() -> None:
    op.execute("CREATE EXTENSION IF NOT EXISTS vector")

def downgrade() -> None:
    op.execute("DROP EXTENSION IF EXISTS vector")
```

Apply it:
```bash
poetry run alembic upgrade head
```

---

## Files to Create/Modify

| File | Action |
|------|--------|
| `src/infrastructure/database/migrations/versions/xxxx_initial_schema.py` | Auto-generated by Alembic |
| `src/infrastructure/database/migrations/versions/xxxx_enable_pgvector.py` | Optional manual migration |

---

## Success Criteria

```bash
cd /Users/maxwell/Projects/MAI

# 1. Verify migration file was created
ls src/infrastructure/database/migrations/versions/*.py
# Expected: At least one .py file (the initial migration)

# 2. Check migration was applied
docker exec mai-postgres psql -U postgres -d mai_framework -c "\\dt"
# Expected: Should list tables: users, user_sessions, conversations, messages, memories, alembic_version

# 3. Verify table structure
docker exec mai-postgres psql -U postgres -d mai_framework -c "\\d users"
# Expected: Should show columns: id (uuid), username, email, hashed_password, is_active, is_superuser, full_name, created_at, updated_at, deleted_at

# 4. Verify alembic_version table has entry
docker exec mai-postgres psql -U postgres -d mai_framework -c "SELECT * FROM alembic_version"
# Expected: Should show the migration version hash

# 5. (Optional) Verify pgvector extension
docker exec mai-postgres psql -U postgres -d mai_framework -c "SELECT * FROM pg_extension WHERE extname = 'vector'"
# Expected: If pgvector migration was run, should show vector extension

# 6. Verify indexes were created
docker exec mai-postgres psql -U postgres -d mai_framework -c "\\di"
# Expected: Should list multiple indexes (idx_users_username, idx_conversations_user_archived, etc.)
```

---

## Technical Notes

- **Async SQLAlchemy:** The env.py is configured for async migrations using `async_engine_from_config`.
- **UUID Primary Keys:** All models use UUID primary keys. PostgreSQL's native UUID type is used.
- **Soft Deletes:** All models inherit `SoftDeleteMixin` with `deleted_at` column.
- **Timestamps:** All models have `created_at` and `updated_at` auto-managed by `TimestampMixin`.
- **Running Migrations:** Can run locally (with localhost DATABASE__URL) or inside container. Local is easier for development.
- **Alembic Version Table:** Tracks which migrations have been applied. Don't delete this table.

---

## Troubleshooting

**"Target database is not up to date" error:**
```bash
# Check current revision
alembic current

# If needed, stamp the database with current head
alembic stamp head
```

**"Can't locate revision" error:**
```bash
# Ensure migrations/versions/ has the migration files
ls src/infrastructure/database/migrations/versions/
```

**Connection refused:**
```bash
# Ensure postgres container is running and healthy
docker compose ps postgres
docker exec mai-postgres pg_isready -U postgres
```

---

## On Completion

1. Mark this task as done in Archon (see command above)
2. Proceed to **04-service-integration.md**
3. Keep containers running for next steps
